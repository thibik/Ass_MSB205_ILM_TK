---
title: "Arbeidskrav i MSB205"
author: 
 - "Thibiga Kuddyar"
 - "Ingrid-Liv Morkken"
format: html
editor: visual
lang: no-NB
---

```{r setup, echo=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(sf)
library(here)
library(tmap)
library(sp)
library(spdep)
library(spatialreg)
library(lmtest)
library(sandwich)
library(units)
library(car)
library(foreign)
library(readr)
library(dplyr)
library(huxtable)
```

## Oppgave 1

## Oppgave 2; House Sales in King County

```{r, message=FALSE}
kc_house_data <- read_csv("kc_house_data.csv")
```

```{r}
kc_house_data <- arrange(kc_house_data, desc(date))
```

```{r}
kc_house_data <- kc_house_data %>% 
  distinct(id, .keep_all=TRUE)
```

```{r}
kc_house_data_sf <- st_as_sf(kc_house_data,
                             coords= c(x = "long", y = "lat"),
                             crs = 4326) %>%
  st_transform(2926)
```

Koordinatene til Seattle hentet fra Wikipedia: 47°36'35N 122°1955V I desimaler: 47.609722, -122.333056

```{r}
cbd <- st_sfc(st_point(c(-122.333056, 47.609722)), crs = 4326) %>%
  st_transform(2926)
```

```{r}
kc_house_data_sf <- kc_house_data_sf %>%
  mutate(
    dist_cbd = st_distance(cbd, ., by_element= TRUE),
    dist_cbd_km = set_units(dist_cbd, km)
  )
```

## Oppgave 3 WADOH Environmental Health Disparities Index County

```{r}
kc_wadoh_map <- here("../Kart/WADOH_Environmental_Health_Disparities_Index_Calculated_for_King_County___wadohehdindex_area.shp") %>% 
  st_read() %>% 
  st_transform(2926)
```

```{r}
kc_wadoh_map <- kc_wadoh_map %>%
select(
GEO_ID_TRT,
EHD_percen,#Environmental Health Index, weighted score many vars
linguist_2,#Pop. age 5+ speaking English less than "very well"
poverty_pe,#Percentage people living in poverty
POC_percen,#People of Color in percentage of pop. in tract
transporta,#% of income spent on transportation median family in tract
unemploy_2,#percentage unemployed
housing_pe,#% of households in group "Unaffordable Housing" (>30% inc.)
traffic_pe,#% of pop. near heavy traffic roadways
diesel,# nox consentration
ozone,# ozone consentration
PM25, # consentration of Particulate Matter in air
toxic_rele, # Toxic release from factories
hazardous_, # Hazardous Waste Treatment Storage and disposal Facilities
lead_perce, # measure of Lead paint in houses
superfund, # Proximity to contaminated sites on national list
facilities, # Proximity to Risk Management Plan Facilities
wastewater, # Proximity to wastewater facilities
sen_pop_pe, # % pop. over 65
socio_perc # score social economic determants, low best
)
```

```{r}
acs_b19101_fam_inc <- read.dbf("../Kart/censusSHP/acs_b19101_familyincome.dbf", as.is = TRUE)
```

```{r}
acs_b19101_fam_inc <- acs_b19101_fam_inc %>% 
  # ag: her var det noen små feil i variablene
  mutate(low = (E19101138 + E19101139 + E19101140 + E19101141 + E19101142 + E19101143)/E19101137) %>% 
  mutate(mid = (E19101144 + E19101145 + E19101146 + E19101147 + E19101148 + E19101149)/E19101137) %>% 
  mutate(high = (E19101150 + E19101151 + E19101152 + E19101153)/E19101137)
# ag: Her total lik 0, så du får NaN. Setter lik 0.2, 0.3 0.5
# Sjekk om det er noe feil i dataene her. Jeg setter dem
# bare til noen verdier
acs_b19101_fam_inc[398, c("low", "mid", "high")] = c(0.2, 0.3, 0.5) 
```

```{r}
acs_b19101_fam_inc <- acs_b19101_fam_inc %>% 
  select(GEOIDTRT, low, mid, high) %>% 
  rename(GEO_ID_TRT = GEOIDTRT)
```

```{r}
# dropper kc_wadoh_map_2 legger heller dataene rett
# til kc_wadoh_map. Rekkefølgene er viktig. Må ha 
# kartet først og legger de nye dataene
# acs_b19101_fam_inc til dette
kc_wadoh_map <- left_join(
  kc_wadoh_map,
  acs_b19101_fam_inc,
  by = "GEO_ID_TRT"
)
```

```{r}
kc_tracts10 <- here("../Kart/censusSHP/tracts10.shp") %>%  st_read() %>% 
  st_transform(2926)
```

```{r}
kc_tracts10_shore <- here("../Kart/censusSHP/tracts10_shore.shp") %>%  st_read() %>% 
  st_transform(2926)
```

```{r}
kc_tracts10_env_data <- left_join(
  kc_tracts10, st_drop_geometry(kc_wadoh_map),
  by = "GEO_ID_TRT"
)
```

```{r}
kc_tracts10_shore_env_data <- left_join(
  kc_tracts10_shore,  st_drop_geometry(kc_wadoh_map),
  by = "GEO_ID_TRT"
)
```

```{r}
#| eval: false
# ag: skrur av for å få mer oversikt
summary(kc_tracts10)
```

```{r}
kc_houses_env_var <- st_join(
  kc_house_data_sf,
  kc_tracts10_env_data   
  )

kc_tracts10_shore_env_var <- st_join(
  kc_house_data_sf, 
  kc_tracts10_shore_env_data
  )
```

## Oppgave 4 "Spatial join"

```{r}
st_write(kc_house_data, "../Kart/censusSHP/kc_house_data.gpkg", append=FALSE)
st_write(kc_tracts10,"../Kart/censusSHP/kc_tracts10.gpkg", append = FALSE)
st_write(kc_tracts10_shore, "../Kart/censusSHP/kc_tracts10_shore.gpkg",append= FALSE)
st_write(kc_houses_env_var, "../Kart/censusSHP/kc_houses_env_var.gpkg", append=FALSE)
st_write(kc_tracts10_shore_env_var, "../Kart/censusSHP/kc_tracts10_shore_env_var.gpkg", append=FALSE)
```

```{r}
#| eval: false
# ag: skrur av for å få mer oversikt
summary(kc_tracts10_env_data)
```

```{r}
#| eval: false
# ag: skrur av for å få mer oversikt
summary(kc_tracts10_shore_env_var)
```

###Spørsmål_ii.
Forklar hvorfor vi har mange flere NA (25 flere) i tracts10_shore enn i tracts10.
Ser dere nå hva som går galt med tracts10_shore?

![Figur1:Kommunegrense](Kart/Skjermbilde_1.png)

![Figur2](Kart/Skjermbilde_2.png)

## Husk å gi bedre navn til figurene!!

```{r}
kc_houses_env_var <- arrange(kc_houses_env_var, desc(id))
kc_houses_env_var_omit <- kc_houses_env_var[-c(11997),]
```

```{r}
st_write(kc_houses_env_var_omit, "../Kart/censusSHP/kc_houses_env_var_omit.gpkg", append = FALSE)
```

## Får ikke til å gjøre om objekte til data.

```{r}
kc_houses_env_var_omit <- kc_houses_env_var_omit %>% 
  mutate(
    year_month = substr(date, start = 1, stop = 7)
  )
```

```{r}
st_write(kc_houses_env_var_omit,"../Kart/censusSHP/kc_houses_env_var_omit.gpkg", append=FALSE)
```

## Oppgave 5; GeoDa

![]()

![](Kart/Skjermbilde_4.png){fig-align="center"}

## 3 naboer

![små&dyr](Kart/Skjermbilde_5.png){fig-align="center"}

![store&dyr](Kart/Skjermbilde_6.png){fig-align="center"}

![](Kart/Skjermbilde_3.png){fig-align="center"}

![stor&billig](Kart/Skjermbilde_7.png){fig-align="center"}

![små&billig](Kart/Skjermbilde_8.png){fig-align="center"}

## 10 naboer

![små&dyr](Kart/Skjermbilde_9.png){fig-align="center"}

![stor&dyr](Kart/Skjermbilde_10.png){fig-align="center"}

![stor&billig](Kart/Skjermbilde_11.png){fig-align="center"}

![små&billig](Kart/Skjermbilde_12.png){fig-align="center"}

## Oppgave 6

### oppgave i. Gi en kort sammenfatning av funnene fra EDA.

Ved å se på pris i forhold til størrelsen på en bolig, ser en at disse billige og små boliger ligger nær sentrum.

### Modell 1

```{r}
mod1 <- "price ~ bedrooms + bathrooms + sqft_living + sqft_living15 + sqft_lot15 + sqft_above + floors + grade + yr_built + yr_renovated + waterfront + condition + year_month"
```

### Modell 2

```{r}
mod2 <- "price ~ bedrooms + bathrooms + sqft_living + sqft_living15 + sqft_lot + sqft_lot15 + sqft_above + floors + grade + yr_built + yr_renovated + waterfront + condition + view + year_month + dist_cbd_km + linguist_2 + poverty_pe + POC_percen + unemploy_2 + sen_pop_pe + facilities + wastewater + traffic_pe + diesel + superfund + transporta + housing_pe + ozone + PM25 + toxic_rele + hazardous_ + lead_perce + socio_perc"
```

### Modell 3

```{r}
mod3 <- "price ~ bedrooms + bathrooms + sqft_living + sqft_living15 + sqft_lot + sqft_lot15 + sqft_above + floors + grade + yr_built + yr_renovated + waterfront + condition + view + dist_cbd_km + low + high + EHD_percen"
#Denne funksjonen funker ikke hvis jeg har med variablene "high + low"
```

```{r}
# da virker den. Problemet var rekke 398 i tractene. 
# Antall folk lik 0, så dividerer med 0
hedon1 <- lm(mod1, data = kc_houses_env_var_omit)
hedon2 <- lm(mod2, data = kc_houses_env_var_omit)
hedon3 <- lm(mod3, data = kc_houses_env_var_omit)
```

```{r}
huxreg("Hedon1" = hedon1, "Hedon2" = hedon2, "Hedon3" = hedon3,
       error_format= "[{statistic}]", 
       note = "{stars}. T statistics in brackets.")
```

```{r}
hedon1 %>% 
  plot()
```

```{r}
hedon2 %>% 
  plot()
```

```{r}
hedon3 %>% 
plot()
```

### Oppgave iii. Rapporter t-verdien som er det vanlige innen økonometri.

### Oppgave iv. Test og diskuter hvilken modell som er best.

## oppgave 7 - Tidsdummy

```{r}
hedon1 %>% 
    linearHypothesis(c("year_month2014-06=0", "year_month2014-07=0",
                       "year_month2014-08=0", "year_month2014-09=0",
                       "year_month2014-10=0", "year_month2014-11=0",
                       "year_month2014-12=0", "year_month2015-01=0",
                       "year_month2015-02=0", "year_month2015-03=0",
                       "year_month2015-04=0", "year_month2015-05=0"),
                     white_adjust = hc3)
```

```{r}
hedon2 %>% 
    linearHypothesis(c("year_month2014-06=0", "year_month2014-07=0",
                       "year_month2014-08=0", "year_month2014-09=0",
                       "year_month2014-10=0", "year_month2014-11=0",
                       "year_month2014-12=0", "year_month2015-01=0",
                       "year_month2015-02=0", "year_month2015-03=0",
                       "year_month2015-04=0", "year_month2015-05=0"),
                     white_adjust = hc4)
```

```{r}
#| eval: false
# ag: her er det et problem
hedon3 %>% 
    linearHypothesis(c("year_month2014-06=0", "year_month2014-07=0",
                       "year_month2014-08=0", "year_month2014-09=0",
                       "year_month2014-10=0", "year_month2014-11=0",
                       "year_month2014-12=0", "year_month2015-01=0",
                       "year_month2015-02=0", "year_month2015-03=0",
                       "year_month2015-04=0", "year_month2015-05=0"),
                     white_adjust = hc1)
```

## Oppgave 8 - Spatial Regressions

```{r}
kc_house_data_2222 <- here("Kart/kc_house_data_2222_Ingrid_og_Thibiga.gpkg") %>%
  st_read() %>% 
  st_transform(2926)
```

```{r}
kc_house_data_2222 <- kc_house_data_2222 %>% 
  mutate(
    dist_cbd=st_distance(cbd, ., by_element=TRUE),
    dist_cbd_km = set_units(dist_cbd, km),
year_month=substr(date, start=1, stop=7))
```

```{r}
kc_house_data_2222 <- kc_house_data_2222 %>% 
  rename(low = inc_fam_low_per,
         mid=inc_fam_med_per,
         high=inc_fam_high_per)
```

```{r}
hedon3_seed <- lm(mod3, data = kc_house_data_2222)
```

```{r}
huxreg("Full" = hedon3, "Seed" = hedon3_seed, error_format="[{statistic}]",
       note = "{stars}. T statistic in brackets.")
```

```{r}
kc_house_data_2222_mat_nb <- knearneigh(kc_house_data_2222, k = 3)
kc_house_data_nb <- knn2nb(kc_house_data_2222_mat_nb)
kc_house_data_2222_W <- nb2listw(kc_house_data_nb, style = "W")
```

```{r}
kc_house_data_2222_mat_nb10 <- knearneigh(kc_house_data_2222, k = 10)
kc_house_data_2222_nb10 <- knn2nb(kc_house_data_2222_mat_nb10)
kc_house_data_2222_W10 <- nb2listw(kc_house_data_2222_nb10)
```

```{r}
lm.morantest(hedon3_seed, kc_house_data_2222_W)
lm.morantest(hedon3_seed, kc_house_data_2222_W10)
```

```{r}
moran.plot(log(kc_house_data_2222$price), listw = kc_house_data_2222_W, labels = FALSE, pch = 20, cex = 0.3)
```

```{r}
moran.plot(log(kc_house_data_2222$price), listw = kc_house_data_2222_W10, labels = FALSE, pch = 20, cex = 0.3)
```

```{r}
kc_lagrange_3 <- lm.LMtests(hedon3_seed, kc_house_data_2222_W, test = "all")
kc_lagrange_3
```

```{r}
kc_lagrange_10 <- lm.LMtests(hedon3_seed, kc_house_data_2222_W10, test = "all")
kc_lagrange_10
```

## Making neighbour matrix

```{r}
SDEM_simp <- errorsarlm(mod3, data = kc_house_data_2222, listw= kc_house_data_2222_W, Durbin = TRUE)
```

```{r}
summary(impacts(SDEM_simp))
```

```{r cache=TRUE}
SDEM_seed <- errorsarlm(mod3, data = kc_house_data_2222, listw= kc_house_data_2222_W, Durbin = as.formula(~ bedrooms + bathrooms + sqft_living + sqft_living15 + sqft_lot + sqft_lot15 + sqft_above + floors + grade + yr_built + yr_renovated + waterfront + condition + view + dist_cbd_km + EHD_percen))
```

```{r}
summary(impacts(SDEM_seed))
```

```{r}
SLX_seed <- lmSLX(mod3, data= kc_house_data_2222, listw=kc_house_data_2222_W, Durbin =  as.formula(~ bedrooms + bathrooms + sqft_living + sqft_living15 + sqft_lot + sqft_lot15 + sqft_above + floors + grade + yr_built + yr_renovated + waterfront + condition + view + dist_cbd_km + low + high + EHD_percen))
# + low + high
#Virker uten low og high 
```

```{r}
#| echo: false
# siste
```
